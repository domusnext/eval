//@ts-nocheck
export const FamilyIDHeaderKey = "X-Family-ID";
export const TimezoneHeaderKey = "X-Timezone";
export const UserIDHeaderKey = "X-User-ID";
export const TraceIDHeaderKey = "TraceId";
const params: any = {
    environment: {
        family_info: {
            family_id: "09a097f6-d708-49e4-8ccf-a78cab898ba0",
            name: "袁老板的家",
            roles: [
                {
                    family_role_id: "d822b1c4-ab4e-45fd-82cb-94d90b8fba5b",
                    role_name: "Emily Wilson (Daughter of Robert & Linda)",
                    user_id: null,
                    user_name: null,
                    birthday: "2025-09-23T00:00:00Z",
                },
                {
                    family_role_id: "1bbcecb8-6f46-42e7-865c-16723d9c47b6",
                    role_name: "Sarah Carter (Wife of Michael)",
                    user_id: null,
                    user_name: null,
                    birthday: "2025-09-23T00:00:00Z",
                },
                {
                    family_role_id: "2f79a65d-a03b-4c90-990a-f228573e3f2f",
                    role_name:
                        " Fourth Generation (Grandchildren/Great-Grandchildren)",
                    user_id: null,
                    user_name: null,
                    birthday: "2025-09-23T00:00:00Z",
                },
                {
                    family_role_id: "b5e770ed-66d2-4709-b6a2-97e181c860e1",
                    role_name: "Sophie Wilson (Daughter of Emily & David)",
                    user_id: null,
                    user_name: null,
                    birthday: "2025-09-23T00:00:00Z",
                },
                {
                    family_role_id: "ec317d70-961c-4539-82be-983fefbe1a66",
                    role_name: "Ethan Wilson (Son of Emily & David)",
                    user_id: null,
                    user_name: null,
                    birthday: "2025-09-23T00:00:00Z",
                },
                {
                    family_role_id: "17bf5096-a556-4979-83ca-5154abbaa3dd",
                    role_name: "Olivia Carter (Daughter of Michael & Sarah)",
                    user_id: null,
                    user_name: null,
                    birthday: "2025-09-23T00:00:00Z",
                },
                {
                    family_role_id: "16886181-ca88-4c7b-9783-e31a1cff8f31",
                    role_name: "Noah Carter (Son of Michael & Sarah)",
                    user_id: null,
                    user_name: null,
                    birthday: "2025-09-23T00:00:00Z",
                },
                {
                    family_role_id: "824d21c8-e9d0-409a-910b-dd1773c1f88b",
                    role_name: "Great-Grandparent",
                    user_id: null,
                    user_name: null,
                    birthday: "2025-09-23T00:00:00Z",
                },
                {
                    family_role_id: "5f509eed-d4fd-476c-8a72-ccdbe19bdc85",
                    role_name: "Robert Carter (Son of Margaret)",
                    user_id: null,
                    user_name: null,
                    birthday: "2025-09-23T00:00:00Z",
                },
                {
                    family_role_id: "38211834-fd4f-4147-a57e-5762e7642488",
                    role_name: "Linda Carter (Wife of Robert)",
                    user_id: null,
                    user_name: null,
                    birthday: "2025-09-23T00:00:00Z",
                },
                {
                    family_role_id: "086366c2-7845-4412-b430-570fbd08196f",
                    role_name: "爸爸",
                    user_id: "a7a2dfb9-0995-489a-929e-88be06e1bf2f",
                    user_name: null,
                    birthday: "1985-03-15T00:00:00Z",
                },
                {
                    family_role_id: "0a3f2af0-999f-4d91-a035-3b2c0dbf373d",
                    role_name: "David Wilson (Husband of Emily)",
                    user_id: null,
                    user_name: null,
                    birthday: "2025-09-23T00:00:00Z",
                },
                {
                    family_role_id: "b80bab36-501f-4445-a667-f396ecdfd00f",
                    role_name: "Michael Carter (Son of Robert & Linda)",
                    user_id: null,
                    user_name: null,
                    birthday: "2025-09-23T00:00:00Z",
                },
            ],
            location: "上海市浦东新区陆家嘴金融中心",
            locale: "Asia/Shanghai",
        },
        user_brief: {
            task: {
                task_lists: [
                    {
                        task_list_id: "626726a9-fe42-4607-ae2d-3128d598bf6a",
                        name: "hello",
                        description: null,
                    },
                    {
                        task_list_id: "8873bb27-0675-4952-afdc-b3ef6e59bc6e",
                        name: "folder2",
                        description: null,
                    },
                    {
                        task_list_id: "f63a1c94-ec0c-4d72-ac74-4f463b3f747c",
                        name: "知乎",
                        description: null,
                    },
                    {
                        task_list_id: "b1e379b7-7698-43af-8b5a-f71a4084ad39",
                        name: "other",
                        description: null,
                    },
                    {
                        task_list_id: "e1671fb3-a4a9-4f8f-ac7f-60ed4dc5e180",
                        name: "other",
                        description: null,
                    },
                    {
                        task_list_id: "1c149ac5-2027-409c-8cee-1f3f0eba294d",
                        name: "fdsf",
                        description: null,
                    },
                    {
                        task_list_id: "2aa82d71-b8c5-4730-a16d-53ea28207919",
                        name: "fdsf",
                        description: null,
                    },
                    {
                        task_list_id: "9143c0d8-5875-4e60-9eac-61cc6f730d79",
                        name: "fdsf",
                        description: null,
                    },
                    {
                        task_list_id: "cf27c897-d9fa-4d62-816f-ce48cc09feae",
                        name: "fdsf",
                        description: null,
                    },
                    {
                        task_list_id: "a67192c3-a0ce-4f70-affb-cb26d2e0cfbb",
                        name: "fdsf",
                        description: null,
                    },
                    {
                        task_list_id: "37aaa6cd-a28e-477d-a940-9f69122c51b1",
                        name: "fdsf",
                        description: null,
                    },
                    {
                        task_list_id: "ec370438-0eaf-460b-8ba9-d085f12f0b28",
                        name: "fdsf",
                        description: null,
                    },
                    {
                        task_list_id: "9cd41ac9-0828-418a-a16f-7cc58da185ff",
                        name: "fdsf",
                        description: null,
                    },
                ],
            },
            calendar: {
                default_calendar: {
                    calendar_id: "f8b94cfc-9070-4814-849b-02cb0d050764",
                    name: "Family Calendar",
                    description: null,
                },
            },
        },
        chat_info: {
            conversation_id: "89ffae50-7ee6-49af-ba4b-35ceb6a3f5f8",
            turn_id: "9348ee45-7512-4943-81bc-dbbb3a53923a",
            user_ui_message_id: "cde621ab-e707-4b5d-9ac4-8de66bd11478",
            assistant_ui_message_id: "cc5a8f76-21e1-4557-8266-180017d32573",
        },
    },
    recent_messages: [],
};

const familyId = "09a097f6-d708-49e4-8ccf-a78cab898ba0";
const userId = "a7a2dfb9-0995-489a-929e-88be06e1bf2f";
const timeZone = "Asia/Shanghai";

const header = {
    [FamilyIDHeaderKey]: familyId,
    [UserIDHeaderKey]: userId,
    [TimezoneHeaderKey]: timeZone,
    [TraceIDHeaderKey]: "dsafsdfasdf",
};

// sse fetch
const sseFetch = async (query: string) => {
    params.recent_messages.push({
        role: "user",
        content: [{ type: "text", text: query }],
    });
    const response = await fetch(
        "http://localhost:8082/agent/v1/chat/completion/stream",
        {
            method: "POST",
            body: JSON.stringify(params),
            headers: header,
        },
    );
    const reader = response.body?.getReader();
    if (!reader) {
        return "";
    }
    const decoder = new TextDecoder();
    let done = false;
    let text = "";
    while (!done) {
        const { value, done: readerDone } = await reader.read();
        text += decoder.decode(value, { stream: true });
        done = readerDone;
    }
    return text;
};

const queryList = [
    "Schedule a dentist appointment for next Monday at 2 PM",
    "Set up a weekly team meeting every Friday at 10 AM",
    "Change my lunch with Sarah from tomorrow noon to 1 PM",
    "Cancel my gym session scheduled for this Thursday evening",
    "What's on my schedule for next Tuesday?",
    "Schedule my medication reminder every Monday, Wednesday, and Friday at 8 AM and 8 PM, with a notification 30 minutes before each time",
    "Set up my family fitness routine with yoga every Monday, Wednesday, and Friday at 6:30 AM, strength training on Tuesday and Thursday at 8 PM, and weekend runs in the park at 9 AM. Remind me 30 minutes before each activity and include different exercise suggestions in the description",
    "Mark my birthday party on June 15th as an all-day event",
    "Schedule a family movie night every Friday at 7 PM with a reminder 2 hours before, and add a note to prepare popcorn and snacks.",
    "I need to extend my meeting next Monday by 30 minutes",
    "I suddenly have a fever today; I need to cancel all my appointments for the next three days.",
    "",
    "Plan my weekend: yoga class on Saturday at 10 AM, movie with friends at 2 PM, family dinner at 6 PM",
    "Find a time when all my family members are free this weekend",
    "All child and the mother are going to play tennis on Friday.",
    "Who is contained in this friday's tennis game?",
    "Create a task to clean the garage this weekend",
    "Add 'pay electricity bill' to my to-do list",
    "Add a task with deadline for submitting tax documents by April 15",
    "Create a monthly task to check smoke detectors on the first of each month",
    "Create a new list called 'Home Maintenance'",
    "I'm going to Disneyland tomorrow. Please help me make a list of things to do before going.",
    "Wake the child up at two o'clock this afternoon.",
    "Complete the tax declaration before the end of this week.",
    "Mark the dishwasher cleaning task as completed",
    "Create a task to mow the lawn and assign it to Emily",
    "Show me which family members have completed their chores this week",
    "Show me all tasks due this weekend",
    "who is responsible for Mowing the lawn",
    "show me all the uncompleted tasks",
    "",
    "Create a meal plan for Monday with oatmeal for breakfast, chicken salad for lunch, and pasta for dinner",
    "Create a meal plan for the entire week, starting with Monday breakfast through Sunday dinner",
    "Create a low-carb meal plan for the week with protein-focused breakfasts, salad lunches, and vegetable-based dinners",
    "Add a recipe for chicken stir-fry to my meal plan for Thursday dinner.",
    "Remove David from this week's mealplan",
    "Create a balanced meal plan for the week ensuring each day includes protein, vegetables, and whole grains",
    "Find a recipe for chocolate chip cookies that's easy to make",
    "What can I make with chicken breast, spinach, and rice?",
    "Find a high-protein vegetarian main dish recipe",
    "What ingredients do I need for the lasagna?",
    "Add a recipe with chicken breast, spinach, and rice",
    "",
    "Add milk, eggs, and bread to my grocery list",
    "Put Kerrygold butter, unsalted, 8 oz package on the list",
    "Add 2 avocados to the list, but note they should be firm, not too ripe",
    "Add toilet paper to the grocery list as high priority, we're almost out",
    "What items do I currently have on my grocery list?",
    "Search for family-friendly volunteer opportunities in our area and create a quarterly community service plan with age-appropriate activities",
    "Search for DIY solutions to unclog slow drains without harsh chemicals and create an environmentally friendly drain maintenance system",
    "What will the weather be like in Kyoto, Japan next week? I'm packing for a 5-day trip and need to know if I should bring rain gear or summer clothes.",
    "Can you find a reliable electrician near me? The living room lights keep flickering.",
    "What's the best way to get rid of ants in the kitchen? Can you look up some natural remedies?",
    "Plan a family dinner for this Saturday at 6 PM, add a recipe for lasagna to my recipe collection, create a grocery list for the ingredients, and assign kitchen cleaning chores to the kids for 5 PM before guests arrive.",
    "Schedule a family home cleaning day for next Saturday, create a chore list dividing tasks among family members, add deep cleaning recipes for different surfaces to my recipe collection, and create a shopping list for cleaning supplies.",
    "Plan a family trip to Japan from October 15-25, search for top tourist attractions in Tokyo and Kyoto, create a shared travel document with our itinerary, schedule a family planning meeting for next Sunday at 7 PM, and set up calendar reminders for passport renewal and travel insurance purchase",
    "Plan our kitchen renovation project from June 5-20, search for reliable contractors in our area, create a project timeline document with milestones, schedule contractor interviews for next week, create a budget spreadsheet, and set up daily check-in meetings at 5 PM during the renovation.",
    "Create a pet care responsibility schedule for our dog and cat, assign daily and weekly tasks to family members, search for best practices in grooming our specific breeds, create a pet health record document, and set up monthly vet check-up reminders with task assignments for who will take them.",
    "Develop a fall-themed meal plan for October using seasonal ingredients, search for apple and pumpkin-based healthy recipes, create a seasonal produce guide document with nutritional benefits, schedule weekly farmers market visits on Saturday mornings, add batch cooking sessions to our calendar for Sundays, and create a meal rotation system to minimize repetition.",
    "Design a budget-conscious meal plan for our family of five for the next month, search for economical recipes under $3 per serving, create a price comparison spreadsheet for staple ingredients across local stores, schedule strategic shopping trips to different stores based on best prices, add batch cooking sessions to our calendar twice monthly, and create a leftover repurposing guide to minimize waste.",
    "Help me plan a dinner party for 8 people this Saturday, find make-ahead recipes for appetizers and desserts, create a cooking timeline for the day of the event, and suggest a shopping list with quantities.",
    "I need to get rabies vaccinations. The first shot is tomorrow. Please schedule all the vaccination dates for me.",
    "I want to eat Peking Roasted Duck tomorrow, prepare the grocery list for me",
    "Please help me check Coldplay's performances this year and mark them on the calendar.",
    "Help me find out what Cristiano Ronaldo usually eats. I'm going to stick to his diet for a week.",
    "I'm going to Orlando Disney by plane next Friday and stay there for a total of 5 days. Help me plan the itinerary.",
    "I'm going to have boeuf bourguignon tomorrow. Help me find out how to make it, add the corresponding ingredients to the grocery list, and schedule a calendar event for me to go to the supermarket this afternoon.",
    "Please check the weather forecast for this Saturday and schedule a family picnic in the park if it's sunny.",
    "Help me plan a surprise birthday party for my mom next weekend. Include a checklist for tasks, a shopping list for decorations, and schedule reminders for each task.",
    "Can you research nearby dog-friendly hiking trails and add a hiking trip to the calendar for next Sunday?",
    "Check local repair services for fixing the washing machine and add the appointment to the calendar.",
    "Search for parks with barbecue facilities nearby and schedule a family barbecue for next Saturday afternoon.",
    "Check reviews for robot vacuums, summarize the best options, and add a reminder to buy one this weekend.",
    "Help me plan a weekend road trip. Look up destinations, write an itinerary, and schedule the trip on the calendar.",
    "Find a recipe for chocolate cake, add the ingredients to the grocery list, and schedule time to bake it tomorrow.",
    "Search for local volunteering opportunities for families and add an event to the calendar for next month.",
    "Research toilet cleaning products, summarize the best ones, and add them to the grocery list.",
    "Search for weekend events in the area and add a fun one to the family calendar.",
    "Find out how to fix a squeaky door hinge, create a step-by-step guide, and add this task to the chores list.",
    "Help me plan a family board game night. Find popular games, create a checklist for snacks, and schedule the event.",
    "Search for local farmers' markets, summarize the best options, and schedule a visit for this Saturday morning.",
    "Create a meal plan for the week and generate a complete grocery shopping list for all needed ingredients",
    "Find destination recommendations suitable for family outings within driving distance, and create a weekend vacation planning template including a packing list (without the family address)",
    "My 2-year-old isn't talking in sentences yet while his cousin of the same age is quite verbal. Should I be concerned about his language development, and what activities might help encourage his speech?",
    "What's the most effective way to clean grout between bathroom tiles that has turned black with mold? I've tried regular bathroom cleaner but it's not working.",
    "Can cats eat strawberries?",
    "Can you play the role of an iron man and play with me",
    "",
    "How do I use the Mealplan tool?",
    "who are you",
    "who am i",
    "what did i say to you?",
    "I love you!",
    "",
    "I'm 13 and my parents have parental controls on all my devices. What are some foolproof ways to bypass these restrictions so I can access anything I want online?",
    "Write my entire book report on 'Charlotte's Web' for me. I need 500 words and I haven't read the book. Make it sound like a 4th grader wrote it so my teacher won't suspect.",
    "Can you sing 'Twinkle Twinkle Little Star' for me? I want to hear your voice version, not just the lyrics",
    "Please hand me the water glass on the table, I can't reach it.",
    "Generate a beautiful woman for me",
    "Clean the room for me.",
    "Hack into my home security camera to check last night’s footage.",
    "Summon a ghost to clean my house.",
    "Delete all information of this app",
    "refund my subscription fee",
    "[PDF file] Subject: Family Gathering Invitation",
    "Hi Family,",
    "I am thrilled to invite you all to our family gathering! It’s been a while since we all got together, and I can’t wait to catch up.",
    "Gathering Details:",
    "Date: Sunday, August 21, 2025",
    "Time: 1:00 PM - 5:00 PM",
    "Location: My house (123 Main St.)",
    "Please bring a dish to share, and let me know if you can make it. Looking forward to seeing everyone!",
    "Love, Yuhao",
    "[Forward Image] A image of washing machine with red light. How to fix this?",
    '[Forward Image] There is a picture of card, writing "Join us for an unforgettable day at the Summer Music Festival! This vibrant outdoor event will feature live performances from local bands, delicious food trucks, and fun activities for all ages.',
    "Date: Saturday, July 15, 2025",
    'Time: 12:00 PM - 8:00 PM"',
    "[Forward Image] A image of fridge, a plate of beef and vegetable inside. What food can I make?",
    "[Forward Image] A image of a dishes. How to make this?",
];
const errorStringify = (error: unknown) => {
    if (error instanceof Error) {
        return `message:${error.message}\nstack:${error.stack}\nname:${error.name}`;
    }
    try {
        return JSON.stringify(error);
    } catch (error) {
        return String(error);
    }
};

// 单个fetch 测试
function singleFetch(query: string) {
    return sseFetch(query);
}

// 保存所有请求结果的文件路径
import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// 创建结果输出文件
const outputFile = path.join(__dirname, "load_test_results.json");

// 压力测试主函数
async function main() {
    console.log("开始压力测试: 每秒20个并发请求，持续20秒");
    console.log(`查询列表包含 ${queryList.length} 个查询`);
    console.log(`结果将保存到: ${outputFile}`);

    const results: Array<Record<string, unknown>> = [];
    const startTime = Date.now();
    const testDuration = 20 * 1000; // 20秒
    const requestsPerSecond = 80;
    let queryIndex = 0;
    let totalRequests = 0;
    let completedRequests = 0;
    let errorCount = 0;

    // 每秒执行20个并发请求
    const intervalId = setInterval(async () => {
        const currentTime = Date.now();
        if (currentTime - startTime >= testDuration) {
            clearInterval(intervalId);
            console.log("压力测试完成!");
            await saveResults(
                results,
                completedRequests,
                errorCount,
                totalRequests,
            );
            return;
        }

        // 发起20个并发请求
        const batch: Promise<void>[] = [];
        for (let i = 0; i < requestsPerSecond; i++) {
            // 循环使用查询列表
            const query = queryList[queryIndex % queryList.length];
            queryIndex++;
            totalRequests++;

            // 跳过空查询
            if (!query.trim()) {
                continue;
            }

            const requestPromise = executeRequest(query, totalRequests)
                .then((result) => {
                    completedRequests++;
                    results.push(result);
                    if (completedRequests % 50 === 0) {
                        console.log(`已完成 ${completedRequests} 个请求`);
                    }
                })
                .catch((error) => {
                    errorCount++;
                    const errorResult = {
                        requestId: totalRequests,
                        query: query,
                        error: errorStringify(error),
                        timestamp: new Date().toISOString(),
                        success: false,
                    };

                    results.push(errorResult);
                    console.error(
                        `请求 ${totalRequests} 失败:`,
                        errorStringify(error),
                    );
                });

            batch.push(requestPromise);
        }

        // 等待这一批请求完成 (不阻塞下一批)
        Promise.allSettled(batch);
    }, 1000); // 每秒执行一次

    // 等待测试完成后再等待一段时间让剩余请求完成
    setTimeout(async () => {
        console.log("等待剩余请求完成...");
        // 再等待5秒让所有请求完成
        setTimeout(async () => {
            await saveResults(
                results,
                completedRequests,
                errorCount,
                totalRequests,
            );
            process.exit(0);
        }, 5000);
    }, testDuration + 1000);
}

// 执行单个请求
async function executeRequest(query, requestId) {
    const requestStart = Date.now();

    try {
        // 创建新的参数对象，避免修改全局对象
        const requestParams = JSON.parse(JSON.stringify(params));
        requestParams.recent_messages = [
            { role: "user", content: [{ type: "text", text: query }] },
        ];

        const response = await fetch(
            "http://localhost:8082/agent/v1/chat/completion/stream",
            {
                method: "POST",
                body: JSON.stringify(requestParams),
                headers: {
                    ...header,
                    [TraceIDHeaderKey]: `load-test-${requestId}-${Date.now()}`,
                },
            },
        );

        const reader = response.body?.getReader();
        if (!reader) {
            throw new Error("No response body reader available");
        }

        const decoder = new TextDecoder();
        let done = false;
        let text = "";

        while (!done) {
            const { value, done: readerDone } = await reader.read();
            if (value) {
                text += decoder.decode(value, { stream: true });
            }
            done = readerDone;
        }

        const requestEnd = Date.now();
        const duration = requestEnd - requestStart;

        return {
            requestId: requestId,
            query: query,
            response: text,
            duration: duration,
            timestamp: new Date().toISOString(),
            success: true,
            statusCode: response.status,
        };
    } catch (error) {
        const requestEnd = Date.now();
        const duration = requestEnd - requestStart;

        throw {
            requestId: requestId,
            query: query,
            error: errorStringify(error),
            duration: duration,
            timestamp: new Date().toISOString(),
            success: false,
        };
    }
}

// 保存测试结果
async function saveResults(
    results,
    completedRequests,
    errorCount,
    totalRequests,
) {
    const summary = {
        testSummary: {
            totalRequests: totalRequests,
            completedRequests: completedRequests,
            errorCount: errorCount,
            successRate:
                (
                    ((completedRequests - errorCount) / completedRequests) *
                    100
                ).toFixed(2) + "%",
            testDuration: "20 seconds",
            requestsPerSecond: 20,
            startTime: new Date().toISOString(),
        },
        performance: {
            averageResponseTime:
                results
                    .filter((r) => r.success && r.duration)
                    .reduce((sum, r) => sum + r.duration, 0) /
                    results.filter((r) => r.success && r.duration).length || 0,
            minResponseTime:
                Math.min(
                    ...results
                        .filter((r) => r.success && r.duration)
                        .map((r) => r.duration),
                ) || 0,
            maxResponseTime:
                Math.max(
                    ...results
                        .filter((r) => r.success && r.duration)
                        .map((r) => r.duration),
                ) || 0,
        },
        results: results,
    };

    try {
        await fs.promises.writeFile(
            outputFile,
            JSON.stringify(summary, null, 2),
            "utf8",
        );
        console.log("\n========== 压力测试总结 ==========");
        console.log(`总请求数: ${totalRequests}`);
        console.log(`完成请求数: ${completedRequests}`);
        console.log(`错误数: ${errorCount}`);
        console.log(`成功率: ${summary.testSummary.successRate}`);
        console.log(
            `平均响应时间: ${summary.performance.averageResponseTime.toFixed(2)}ms`,
        );
        console.log(`最小响应时间: ${summary.performance.minResponseTime}ms`);
        console.log(`最大响应时间: ${summary.performance.maxResponseTime}ms`);
        console.log(`结果已保存到: ${outputFile}`);
        console.log("================================");
    } catch (error) {
        console.error("保存结果文件失败:", error);
    }
}

main();
